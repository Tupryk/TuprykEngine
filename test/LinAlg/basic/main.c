#define DEBUG

#include <stdio.h>
#include "../../../TuprykEngine/visual/prints/linalg.h"
#include "../../../TuprykEngine/LinAlg/tensor.h"

void print_counts(struct tensor* a, int* counts)
{
    printf("(");
    for (int i = 0; i < a->shape_dim; i++) {
        if (i != a->shape_dim-1) printf("%d, ", counts[i]);
        else printf("%d", counts[i]);
    }
    printf(")\n");
}

int test_basic()
{
    int shape[] = {3, 2, 2};
    struct tensor* t = new_tensor(shape, 3, NULL);
    fill_random(t);

    printf("--- Test 1: Create tensor ---\n");
    print_tensor(t);

    printf("--- Test 2: Get 1D indices ---\n");
    for (int k = 0; k < shape[2]; k++) {
        for (int j = 0; j < shape[1]; j++) {
            for (int i = 0; i < shape[0]; i++) {
                int indices[] = {i, j, k};
                int index = get_tensor_value_index(t, indices);
                printf("(%d, %d, %d) -> %d\n", i, j, k, index);
            }
        }
    }

    printf("--- Test 3: Copy tensor ---\n");
    struct tensor* t_copy = tensor_copy(t);
    print_tensor(t_copy);

    printf("--- Test 4: Loop through tensor ---\n");
    tensor_loop(t, print_counts);

    printf("--- Test 5: Add tensors ---\n");
    tensor_add(t, t, t);
    print_tensor(t);
    tensor_sub(t, t, t);
    print_tensor(t);

    printf("--- Test 6: Identity tensor ---\n");
    struct tensor* I = new_tensor(shape, 3, NULL);
    tensor_identity(I);
    print_tensor(I);

    tensor_free(t);
    tensor_free(t_copy);

    printf("\033[1;32mSuccess\033[0m\n");

    return 0;
}

int test_tensor_transpose()
{
    int a_shape[] = {4, 3};
    int a_right_shape[] = {3, 4};
    float a_values[] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12};
    float a_values_right[] = {1, 4, 7, 10, 2, 5, 8, 11, 3, 6, 9, 12};
    struct tensor* A = new_tensor(a_shape, 2, a_values);
    struct tensor* A_right = new_tensor(a_right_shape, 2, a_values_right);

    printf("--- Test 7: Transpose tensor ---\n");
    printf("A\n");
    print_tensor_verbose(A, 1);
    tensor_transpose(A);
    printf("A^T right\n");
    print_tensor_verbose(A_right, 1);
    printf("A^T\n");
    print_tensor_verbose(A, 1);

    int failure = !tensors_equal(A_right, A);

    tensor_free(A);
    tensor_free(A_right);

    int a_shape_b[] = {2, 3, 4, 5};
    int a_right_shape_b[] = {5, 4, 3, 2};
    float a_values_b[] = {-0.1826261451365334, 0.8576725644119633, 0.7437873977470703, -0.5130471791021952, 0.05528031818026196, 0.5257169385730138, -1.8982829027129902, 1.8565355949419176, -1.5811066578134902, -0.21733277452816271, -0.004789791904240689, -1.7800529909487746, 0.014202788933131663, -0.7926326703330119, -0.3582436790468727, -0.015480572968957756, -0.22519694757528438, 0.35651988749587776, -0.20278405864385465, 1.1626882865942272, -0.28237775566243306, -0.47363298162554474, -1.3522606802263704, 0.07267091419903296, -0.4222834193965733, -0.33739345093504086, -1.4681447293435528, -0.2272187988051435, -0.16509814607134504, 0.4776916160919216, 0.8434068700667746, -0.5111749199290679, -0.30589681704032434, -1.6006111549511766, 1.1924870286163858, 0.9015166504273542, 0.28672518171752154, 0.9892957884519146, -2.4695717771977153, 0.3479032970212525, 0.6171214430333354, 1.5667456300974485, 0.0862569506495498, 0.22490522019360268, 0.29353964972741514, 0.5395158368360635, 0.377602824629829, 0.7931692434681775, 2.3880199553297476, -0.4884727287172514, 0.8495073022942536, -0.12008484738949686, 0.2572355379507907, 0.21884483630020066, 0.7971546247258401, 0.2873983095386936, -1.8313808686819337, 1.259731721890978, -0.1515854132109895, 0.6687342869364047, 0.3811266055313551, 1.1210165562028915, 1.3494615999215362, -1.0256882716503584, 0.7608696658692788, 2.1322425261335662, -1.7503458521220607, 1.785571326418091, 0.835484056968454, 0.5480456663291436, -0.24014994394627934, -0.8576094649623622, -0.592782441893672, -0.9432604140429905, -1.0958241665357558, -0.3012672307602753, -0.6311735228150511, -0.7010122187734822, 1.9076271535411464, -0.34292088046545205, 0.08122880074931106, -0.7171106294621575, -2.2537079998317386, -1.09896148677393, -0.744910376946679, -1.7335938084873355, 0.9426527734316931, -1.636819005604207, 0.4251098663880116, 0.4015540193503443, -0.14575724150341557, -0.19947845525993987, 1.8603151396529434, 0.5783854316405149, 0.09021648686127078, -2.2217138992830043, 0.02512713260693775, 0.3869549369955165, -0.25286177656140785, -0.2461747306784905, -0.3686588494747314, -0.3849310148557622, 2.77537718674338, -1.8112074506017157, 0.27560721580336817, -0.6708225320742975, -0.79857271692658, 0.6312934630942972, -1.3011344023030709, -0.9291892215385333, 0.46285653636335744, 0.8232565942968678, 0.6293213924580658, 0.02193518530914915, -0.8256718497334186, 1.178270931225626, 0.9482925536246797, -0.18495498236906968, 0.004602507563392487, 0.9117631195431367};
    float a_values_right_b[] = {-0.1826261451365334, 0.3811266055313551, -0.28237775566243306, 0.08122880074931106, 0.6171214430333354, -0.3686588494747314, 0.5257169385730138, 2.1322425261335662, -0.33739345093504086, -1.7335938084873355, 0.5395158368360635, -0.6708225320742975, -0.004789791904240689, -0.24014994394627934, 0.8434068700667746, -0.14575724150341557, 0.8495073022942536, 0.46285653636335744, -0.015480572968957756, -0.3012672307602753, 0.9015166504273542, -2.2217138992830043, 0.2873983095386936, 1.178270931225626, 0.8576725644119633, 1.1210165562028915, -0.47363298162554474, -0.7171106294621575, 1.5667456300974485, -0.3849310148557622, -1.8982829027129902, -1.7503458521220607, -1.4681447293435528, 0.9426527734316931, 0.377602824629829, -0.79857271692658, -1.7800529909487746, -0.8576094649623622, -0.5111749199290679, -0.19947845525993987, -0.12008484738949686, 0.8232565942968678, -0.22519694757528438, -0.6311735228150511, 0.28672518171752154, 0.02512713260693775, -1.8313808686819337, 0.9482925536246797, 0.7437873977470703, 1.3494615999215362, -1.3522606802263704, -2.2537079998317386, 0.0862569506495498, 2.77537718674338, 1.8565355949419176, 1.785571326418091, -0.2272187988051435, -1.636819005604207, 0.7931692434681775, 0.6312934630942972, 0.014202788933131663, -0.592782441893672, -0.30589681704032434, 1.8603151396529434, 0.2572355379507907, 0.6293213924580658, 0.35651988749587776, -0.7010122187734822, 0.9892957884519146, 0.3869549369955165, 1.259731721890978, -0.18495498236906968, -0.5130471791021952, -1.0256882716503584, 0.07267091419903296, -1.09896148677393, 0.22490522019360268, -1.8112074506017157, -1.5811066578134902, 0.835484056968454, -0.16509814607134504, 0.4251098663880116, 2.3880199553297476, -1.3011344023030709, -0.7926326703330119, -0.9432604140429905, -1.6006111549511766, 0.5783854316405149, 0.21884483630020066, 0.02193518530914915, -0.20278405864385465, 1.9076271535411464, -2.4695717771977153, -0.25286177656140785, -0.1515854132109895, 0.004602507563392487, 0.05528031818026196, 0.7608696658692788, -0.4222834193965733, -0.744910376946679, 0.29353964972741514, 0.27560721580336817, -0.21733277452816271, 0.5480456663291436, 0.4776916160919216, 0.4015540193503443, -0.4884727287172514, -0.9291892215385333, -0.3582436790468727, -1.0958241665357558, 1.1924870286163858, 0.09021648686127078, 0.7971546247258401, -0.8256718497334186, 1.1626882865942272, -0.34292088046545205, 0.3479032970212525, -0.2461747306784905, 0.6687342869364047, 0.9117631195431367};
    A = new_tensor(a_shape_b, 4, a_values_b);
    A_right = new_tensor(a_right_shape_b, 4, a_values_right_b);

    printf("A\n");
    print_tensor_verbose(A, 1);
    tensor_transpose(A);
    printf("A^T right\n");
    print_tensor_verbose(A_right, 1);
    printf("A^T\n");
    print_tensor_verbose(A, 1);

    failure += !tensors_equal(A_right, A);

    printf("--- Test 8: Vector transpose ---\n");
    int v_shape[] = {3, 1};
    TYPE v_values[3] = {1.f, 2.f, 3.f};
    struct tensor* v = new_tensor(v_shape, 2, v_values);
    print_tensor_verbose(v, 1);
    tensor_transpose(v);
    print_tensor_verbose(v, 1);

    tensor_free(v);
    tensor_free(A);
    tensor_free(A_right);

    printf("\033[1;32mSuccess\033[0m\n");

    return failure;
}

int test_matrix_mult()
{
    printf("--- Test 9: Multiply Matrix ---\n");
    int shape_a[] = {3, 4};
    TYPE a_values[] = {-1.026171548179903, -0.458737870232199, 0.004127730314223807, 0.8360107337310204, 0.8292537172427407, 1.2425586400298345, 0.35083116511410856, -0.32207087467934237, 0.23016262279879746, 0.20249721733526918, 0.9171447250259418, 1.6059787055761126};
    struct tensor* a = new_tensor(shape_a, 2, a_values);
    printf("----- a -----\n");
    print_tensor(a);
    int shape_b[] = {4, 3};
    TYPE b_values[] = {-0.461208869566718, 0.9674342887379879, -0.0806642360197525, -1.1021043520971685, 0.05480518249617046, 0.40797513844761685, -0.8164268123080939, 1.2007674054723112, -1.370489531486717, -0.31479676906853793, 0.8693183496057981, -0.5887653735725717};
    struct tensor* b = new_tensor(shape_b, 2, b_values);
    printf("----- b -----\n");
    print_tensor(b);

    struct tensor* c = tensor_mult_give(a, b);
    
    TYPE c_right_values[] = {0.7123129553846224, -0.28617883921288156, -0.6022494853002759, -1.9369295534586541, 1.0116316398136462, 0.148855655366783, -1.5836645595766565, 2.731149359977949, -2.138433958895186};
    int shape_c[] = {3, 3};
    struct tensor* c_right = new_tensor(shape_c, 2, c_right_values);
    printf("----- c right -----\n");
    print_tensor(c_right);
    printf("----- c -----\n");
    print_tensor(c);

    int failure = !tensors_equal(c_right, c);

    tensor_free(a);
    tensor_free(b);
    tensor_free(c);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int test_tensor_mult()
{
    printf("--- Test 10: Multiply Tensors ---\n");
    int shape_A[] = {3, 2, 3, 4};
    TYPE A_values[] = {-2.9990088574943696, -0.09758899819250835, -1.3956673649968252, -0.41124949162606944, 2.1125258147798505, -0.1450286841944067, -1.7519672168342109, -2.0143613529194333, 0.3549097965273545, -0.7301193763953743, -0.38098925743414586, -0.0023863698615277204, -1.8857264657323594, 0.832245225865025, -0.3069576609175541, -1.333075816071064, -0.6973502866902077, 0.6392810299852351, 0.4616131942774141, -0.9201761927204661, -1.4358020868090116, -0.6745209712817429, -0.5574311720757029, 0.4212630032357984, 0.5376433654151268, -2.123035363280394, -1.0533446913275575, -0.263773561299935, -2.268953765343443, 1.1196894581451629, -0.9533177230608904, 0.717482935831291, -0.084880578965417, 0.7856380843302334, 0.3502228344800161, 0.12529212602363796, -0.7192256577393755, -1.4037809129575614, 1.1532653315009445, 2.0462486014471426, 2.432104773683684, -1.3896987716912848, -0.8035448429375516, -0.5805195139327286, 0.11859343865133863, -0.6066293934004098, -0.3707204399598877, 0.21411832479521414, 1.3289408446490172, -0.7727748833269149, -0.6600380564706506, -1.079931090470543, 0.025631543390287455, 1.8968605916688115, 0.7550104530954248, 1.984031081546031, 0.49116070461355715, -0.3549055621349993, 0.5821758100606579, -0.2144424394009957, -1.2789999481247591, -1.2725487681001115, 0.5383568587632326, -1.307089454629118, 2.254231784696408, -0.4846612623749919, -0.024416976578145004, 0.9702876701522997, -0.33685444319161256, -0.3128347912512463, -0.2547143847963123, -2.269815987432165};
    struct tensor* A = new_tensor(shape_A, 4, A_values);
    printf("----- A -----\n");
    print_tensor(A);
    int shape_B[] = {2, 4, 3};
    TYPE B_values[] = {-0.40362719738447045, 0.18158905927360294, -0.4865402126069729, -0.42323484416447477, 0.4391587385457016, -1.673168042051677, 1.0403126434006877, 1.4132188948049669, -0.08216082035837821, -1.1442415684383216, -2.2247944283278724, -0.6519369104973635, -0.18964689153276668, 0.5758175071984977, -0.3624015210088019, 2.436349774803363, -2.6657049129509827, 0.5040038611106545, -1.388403491536073, 0.04397117621400422, 0.05680552881218396, 1.4763749043630037, -0.9247140237832875, 0.22625926044370984};
    struct tensor* B = new_tensor(shape_B, 3, B_values);
    printf("----- B -----\n");
    print_tensor(B);

    struct tensor* C = tensor_mult_give(A, B);
    
    int shape_C[] = {3, 2, 3, 3};
    TYPE C_right_values[] = {0.27042296205358496, -1.6448821719815903, 2.0051990988369153, -0.3089693340976095, 2.3255477020984894, 0.6720081813378473, -0.22785664392182203, -0.7893026031989709, 1.0817926721420703, 0.8433240388357679, -2.0851378876358186, 0.7837873061038342, -0.30966790157780133, -1.2344835812457091, 0.39294470878457854, 0.02480789785204357, 0.557255177489718, 0.24402516925936232, -0.1124520703938691, -1.7364840500820202, 3.5491171892549045, -1.3708024243316854, -2.863794426821945, -1.1589196133366209, -0.07727251806807255, 0.545798748771566, -1.3836638773226215, -1.8638699305154944, 1.4864386062329182, 0.08163201429333095, -3.5884533759886734, 5.6064570749763, -1.7588057215718087, -0.6696237884805992, 1.47108390106353, -0.3213347159037256, 0.33972469819693946, 1.371796695230669, 1.4046752842439771, -2.2979270012637008, -2.5093889452769176, -4.541732670617379, 0.8029813907028347, 1.2331617305853582, 0.4468181101390121, -5.535026151125793, 3.8881250745954716, -0.4430174132899163, -0.1419034264457059, 1.6916777762679727, -0.843058623648331, -3.695744595336457, 2.727689138101023, -0.5636294520932955};
    struct tensor* C_right = new_tensor(shape_C, 4, C_right_values);
    printf("----- C right -----\n");
    print_tensor(C_right);
    printf("----- C -----\n");
    print_tensor(C);
    
    struct tensor* C2 = tensor_mult_give(B, A);

    int shape_C2[] = {3, 2, 4, 4};
    TYPE C2_right_values[] = {1.4214152276200132, 0.3682863881253254, 0.4305578225445027, -0.19863343848313678, 1.6031954890528257, 1.1992248579058546, 0.4587623967153509, -0.7065764784334088, -0.16360511494781413, -0.24649313854451987, -3.896541189758378, -3.274365504535843, -1.4997238598145255, 0.9103161674390209, 5.7431284767922905, 4.953664440526655, 0.4764125189082968, 0.4547239149519368, 0.5260324296618935, -0.42970622989770885, -3.4590089603923895, -0.016455287696685084, -2.259328250948541, -0.5826025863911569, 2.505924399955022, -1.1656987590540449, 0.41481359077380386, 1.8343159556651403, -2.464053159213608, 0.48493721606109164, -1.0061687463344882, -1.0219051951359943, -0.5877268496228405, 0.6779936484299701, 0.08164900477314824, 0.1757935770205601, -1.0819608072685016, 0.07575941581554958, -0.5588272866559026, 0.21709228195576052, -2.6402372839400834, -0.6908029017560433, -2.4718290146182667, 0.7292593669432238, 4.4880985899785175, -0.5740000194761525, 3.0978935477063754, -1.376113926112878, 1.493868975780078, -0.3141467810797036, -0.5470587223036535, -0.7999347925421914, -8.175787362303598, -0.021318024475030905, 4.764926633153485, 6.6407875021131675, 1.1122546849784882, 1.8534477278424268, -1.6575893954414864, -2.854381723974452, -3.284015239473242, -0.9246884860111824, 2.3618222459262768, 3.606290872693518, -0.7707116944103317, 0.829037918437223, 0.12025900641812727, 0.9005027671406315, -1.3729921494975617, 1.7539048064640819, -0.36315741810585594, 1.68716729025624, 1.3783827780232805, 1.9059110794645753, 0.3325170606702915, 1.6980230116440247, -1.8978600636905658, -3.1045076954151316, -1.30404196738829, -3.0385563096650077, 1.66266105391515, 0.07563028243151554, -0.023848546913338483, 1.6291788457737189, -9.294983918983599, -1.9660799390373365, 1.2483370326176515, -6.915023729410754, 1.8557540219047337, 1.7277292812602547, -0.7629993709034201, 1.7284941552071575, -4.049019607453487, -1.5013677682079631, 0.7597637882015451, -3.3405595709255094};
    struct tensor* C2_right = new_tensor(shape_C2, 4, C2_right_values);
    printf("----- C2 right -----\n");
    print_tensor(C2_right);
    printf("----- C2 -----\n");
    print_tensor(C2);

    int failure = !tensors_equal(C_right, C);
    failure += !tensors_equal(C2_right, C2);

    tensor_free(A);
    tensor_free(B);
    tensor_free(C);
    tensor_free(C2);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int test_tensor_mult2()
{
    printf("--- Test 11: Multiply Tensors ---\n");
    int shape_A[] = {3, 2, 3, 4};
    TYPE A_values[] = {-1.0113988236131461, -0.21507443364559273, 0.873254731254193, 0.07496565553949315, -0.47174485315451226, -0.17823823869293182, 0.7128762319546577, 1.264816230391694, -0.2788781473738857, 0.10587329051466311, -1.4010020732910142, -1.3278476315571646, 1.451426523506782, 0.8233384663145862, -0.8112830341635738, -1.245407515384993, -2.0204865006562134, -1.4917424573357856, -0.5443589035958506, -0.041372332892162744, -0.6654752122364967, -1.076055201352991, -0.006883790483822652, -0.14021494809807708, -1.5379007213874114, -0.293083784936983, -0.605434190931024, -0.6762870224424018, -0.09299312570251195, 1.3855932896993362, -2.1296574947167626, 0.28116437590617205, -0.4690677444000954, -0.9954188957192219, -0.06677862716746912, -1.3112537720138355, -1.099007900103591, -1.143956618193387, -0.019366044676437977, -1.7425036307314787, -0.5625638517031728, -0.9070409400714778, -0.08333907057664913, -0.41751443927527765, -1.9169806936059595, 1.0071271952667973, -0.2738077497947024, 0.6896201028509703, 2.2964940525403037, 0.8708272308424092, 1.2647966215161854, -0.1946654090653992, 1.3927397341077583, -1.5540405691546137, 1.1551495589750647, -0.5310675392544031, -1.3969180697086179, 1.1278100132480933, 0.25932511463439595, -1.0376472597125737, -0.23456115092783705, -0.7461613734867099, -0.3491699843941692, 0.6023009495278888, 0.7015285008856119, -0.4500471481015848, -0.6827741388226396, -0.21836703280523573, -0.047568683778735035, 0.911113705731055, -2.074617172260707, -0.37788173728341956};
    struct tensor* A = new_tensor(shape_A, 4, A_values);
    printf("----- A -----\n");
    print_tensor(A);
    int shape_B[] = {3, 2, 4, 3};
    TYPE B_values[] = {-0.18315843746040888, 0.17500832981638625, -1.3122318056067797, 0.00710208844704866, -0.07728126799302525, -0.6818502434876061, -2.10777562342173, 1.160794161473788, 0.2957564803942622, 1.6811918906528456, 0.09921247137984344, -1.6572158585382086, -0.24777007310758453, 1.0649865299766788, -1.1893871681852777, 0.5137998875273736, -1.6240551411301276, -0.004012239588331702, 1.9479911625500146, 0.24799970696938137, 0.8655651397942093, 0.13520560160590178, -0.36095817868787927, 0.7073799600647169, 1.56208518204, 0.3460260528114539, -0.028443939120048615, 0.48282530784973926, -0.402198886801798, -1.0519816721959983, 1.122082406543971, 0.01798723008646578, -1.1323364915823324, -0.9850955110840107, -0.21064626647521173, -2.1020985770177356, -1.4649488858383697, -2.358373424856161, -2.1882166340265843, 0.109208828264218, -0.17170194513919923, -0.9039306972462039, -0.796335513175844, -1.0417527212706734, -0.43000813213426536, -1.2626414674883895, -0.6303731065391693, 1.3076595602950096, 0.9222048002662004, -0.014368083125491572, -0.012150862329215037, -0.6087991806869345, -1.0529499862528302, 1.2333138408678468, 0.14504939356749055, -1.4291882338307893, -0.7449088852998086, 0.5741806340187612, -0.5265655458438725, 0.41625154153419835, -0.22673552608377162, 2.650138235477532, -0.6243078631375166, -1.1650834906853678, 0.6601356387792486, -0.069158574385008, 0.7684947427913162, 0.005438407432266995, 1.0733455789051054, 0.4150959963459601, -0.3286272817202412, 1.2389787128759953};
    struct tensor* B = new_tensor(shape_B, 4, B_values);
    printf("----- B -----\n");
    print_tensor(B);
    
    struct tensor* C = tensor_mult_give(A, B);
    
    int shape_C[] = {3, 2, 3, 3};
    TYPE C_right_values[] = {-1.5308746328729816, 0.8607245275201308, 1.6078747320452746, 0.7089538319177822, 0.8842033102058835, -1.1446653629297705, 0.772462155437881, -1.8150020929632984, 2.0799377564737696, -1.6853470976897107, 0.4569447014129712, -3.3128061451876767, -1.3318411234371137, 0.15081393323056866, 1.9086818958367853, -0.42035960888036317, 1.08775539909937, 0.6906814559990242, -2.5569799409673712, -0.28270849194762127, 2.45923993983792, -2.1428886484059584, -0.6869949883158586, 0.36548000626375793, 0.0034418743596338437, 0.5130562606083425, 3.8925051334780143, 3.7006394474625632, 3.9068926584118615, 1.168650896559623, 1.3186073153520064, 1.8324849090449549, 1.5407834573815538, 2.265565808450875, 4.198552627220334, 4.3039237325410555, 1.6593638093171585, -2.655062090466625, 0.022910875658841104, 2.0931149401844436, 0.24503170634132482, -3.0150815841822016, -2.5330363723548985, -0.9916916098686589, 0.782821604861797, 0.9042010589878743, -1.314018642009652, 0.5694998239365422, -0.2500705486783369, 1.6301035023383417, -1.4102498486848198, -2.8019276125682775, 0.5882946751263739, -2.7282824199142324};
    struct tensor* C_right = new_tensor(shape_C, 4, C_right_values);

    printf("----- C right -----\n");
    print_tensor(C_right);
    printf("----- C -----\n");
    print_tensor(C);

    int failure = !tensors_equal(C_right, C);

    tensor_free(A);
    tensor_free(B);
    tensor_free(C);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }
    
    return failure;
}

int test_tensor_mult3()
{
    printf("--- Test 12: Multiply Tensors ---\n");
    int shape_A[] = {3, 2, 3, 4};
    TYPE A_values[] = {0.008499498356825659, 0.10074938109611803, 1.3975352006934396, -0.4602104683672279, 0.5060111748997177, -1.7020394352561004, -0.5224327243667218, 0.49372149262558684, 0.719282447528419, -0.3465575041148004, -0.05537339850623615, -0.23238680256167096, 0.22905954165622688, 0.29244586563455377, 0.20126359547158007, -0.6195296981286892, 1.059267102312194, 0.8000279147881619, 0.6591358386064154, 1.3301242742749422, -1.0818549450609232, -0.16459159826368455, 1.4935904990834656, -0.021565929899370295, 0.1192235368645112, 0.5413386579341769, 0.48714499494068175, -1.070557910224196, 0.26089455050858673, -0.024149851573531653, 0.5098854946111867, 1.7517183211684064, 0.2352705358647581, -0.37821704821244734, -0.4219597560509851, 0.7449753579921926, 0.5844166212008727, 0.7699368914708601, -0.24528348783116252, -1.9817582317841087, -0.03430336878504484, 0.761862327362496, -1.2051505887776763, -0.19254833034827515, 0.9584538969730436, -0.6752130243225252, -0.25338448260924135, -0.4896591282650769, -0.23586017173133475, 0.1314508168374758, -1.645302996558174, 0.9017623029080588, -0.023004560020367115, -0.8585068849255808, -0.7198476303409568, 0.8112440269110404, -0.1662791101898898, -0.7686258717186482, 1.9864592681675508, -0.29045443136705923, -0.8980630750334335, -0.9050192952466356, -1.265058177661152, 1.1265712136391226, -0.22681742456636209, 0.03986100300356584, 0.28685524545182806, 0.21872638125977625, 0.9105799706682746, 0.11873438451797153, -0.40391790621345974, -0.8262346334204902};
    struct tensor* A = new_tensor(shape_A, 4, A_values);
    printf("----- A -----\n");
    print_tensor(A);
    int shape_B[] = {3, 2, 4, 2};
    TYPE B_values[] = {-0.8966681226516695, -1.8374208516140216, -0.5522526890619387, -1.8387663535697445, -0.42079681490536863, -2.2969012614380233, -0.7317889948711805, 0.2616110641244722, 2.1443764535389276, -0.1636407965584656, 1.1537870299167228, 0.01858430613331185, 1.8205088719345388, -1.2965681528962385, 0.08702331726028252, -1.4699158228391704, 1.5740019900280975, 0.9756851007890424, -0.46810570170444143, -0.7261287257013219, 0.42108649522666614, 0.9277337344592721, -0.22599873711608834, -0.15927093381060373, -0.3261070641953518, 0.38196937752740323, 0.7825581324745419, 0.06161926141835899, -1.9868046607453744, -0.93866549176954, 1.3143615824757107, -0.3509320325845706, 0.9242338480105351, 0.3342529505267832, -0.9642245741318428, 1.684663405395834, 1.0077774927858305, 1.4824540074476307, 0.511597299891696, -0.6563856262544338, 0.8632119257046776, -0.842255285303239, 0.9436278824581743, -0.23874738562214187, -0.8884645248906198, -1.523677485944273, 1.0509449291601187, 1.4882346978662608};
    struct tensor* B = new_tensor(shape_B, 4, B_values);
    printf("----- B -----\n");
    print_tensor(B);
    
    struct tensor* C = tensor_mult_give(A, B);
    
    int shape_C[] = {3, 2, 3, 2};
    TYPE C_right_values[] = {-0.31456175096103867, -3.531268243339183, 0.34476983635262315, 3.529036750768645, -0.26021127392977045, -0.6179940189728402, 1.1410987659889844, 0.6176559554107247, 4.510243732569404, -2.968256602575766, 0.20741009421574216, -1.7308649886653142, 0.38132928625800105, 0.3456926821626671, 0.24077299243045314, 0.46612698803386116, 0.2013168035051266, -0.005935001451090848, -1.7054785214792856, 1.1963737857071353, 2.748708809493909, 1.2326472045038663, -0.9811157055363636, 0.7341742536875233, -1.5414982314286052, -2.8883764122176734, 0.4961158561053337, -3.053614397376681, 2.440760409936165, 1.7850294548408978, 0.6787034195252588, 4.57661239562735, -0.18316888009062696, 0.06996277509406446, 0.38860419817536007, -1.4094787470417276};
    struct tensor* C_right = new_tensor(shape_C, 4, C_right_values);

    printf("----- C right -----\n");
    print_tensor(C_right);
    printf("----- C -----\n");
    print_tensor(C);

    int failure = !tensors_equal(C_right, C);

    tensor_free(A);
    tensor_free(B);
    tensor_free(C);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int test_tensor_inner_outer()
{
    printf("--- Test 13 & 14: Inner product & Outer product ---\n");
    int v1_shape[] = {3};
    TYPE v1_values[3] = {1.f, 2.f, 3.f};
    struct tensor* v1 = new_tensor(v1_shape, 1, v1_values);
    struct tensor* v2 = tensor_copy(v1);
    tensor_transpose(v1);
    printf("--- v1 ---\n");
    print_tensor(v1);
    printf("--- v2 ---\n");
    print_tensor(v2);

    struct tensor* v3 = tensor_mult_give(v2, v1);
    struct tensor* v4 = tensor_mult_give(v1, v2);
    
    int v3_shape[] = {1, 1};
    TYPE v3_right_values[] = {14.};
    struct tensor* v3_right = new_tensor(v3_shape, 2, v3_right_values);
    int v4_shape[] = {3, 3};
    TYPE v4_right_values[] = {1., 2., 3., 2., 4., 6., 3., 6., 9.};
    struct tensor* v4_right = new_tensor(v4_shape, 2, v4_right_values);
    
    printf("--- Test 13: Inner product ---\n");
    printf("--- v3 right ---\n");
    print_tensor(v3_right);
    printf("--- v3 ---\n");
    print_tensor(v3);
    printf("--- Test 14: Outer product ---\n");
    printf("--- v4 right ---\n");
    print_tensor(v4_right);
    printf("--- v4 ---\n");
    print_tensor(v4);

    int failure = !tensors_equal(v3, v3_right);
    failure += !tensors_equal(v4, v4_right);

    tensor_free(v1);
    tensor_free(v2);
    tensor_free(v3);
    tensor_free(v4);

    tensor_free(v3_right);
    tensor_free(v4_right);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int test_append()
{
    printf("--- Test 15: Append Tensors ---\n");
    int shape_A[] = {2, 2};
    TYPE A_values[] = {1, 2, 3, 4};
    struct tensor* A = new_tensor(shape_A, 2, A_values);
    printf("----- A -----\n");
    print_tensor(A);
    int shape_B[] = {1, 2};
    TYPE B_values[] = {5, 6};
    struct tensor* B = new_tensor(shape_B, 2, B_values);
    printf("----- B -----\n");
    print_tensor(B);
    
    struct tensor* C = tensor_append(A, B, 0);
    
    int shape_C[] = {3, 2};
    TYPE C_right_values[] = {1, 2, 3, 4, 5, 6};
    struct tensor* C_right = new_tensor(shape_C, 2, C_right_values);

    printf("----- C right -----\n");
    print_tensor(C_right);
    printf("----- C -----\n");
    print_tensor_verbose(C, 1);

    int failure = !tensors_equal(C_right, C);

    tensor_free(A);
    tensor_free(B);
    tensor_free(C);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int test_append_harder()
{
    printf("--- Test 15: Append Tensors ---\n");
    int shape_A[] = {2, 2, 2};
    TYPE A_values[] = {1, 2, 3, 4, 11, 12, 13, 14};
    struct tensor* A = new_tensor(shape_A, 3, A_values);
    printf("----- A -----\n");
    print_tensor(A);
    int shape_B[] = {2, 2, 1};
    TYPE B_values[] = {5, 6, 15, 16};
    struct tensor* B = new_tensor(shape_B, 3, B_values);
    printf("----- B -----\n");
    print_tensor(B);
    
    struct tensor* C = tensor_append(A, B, 2);
    
    int shape_C[] = {2, 2, 3};
    TYPE C_right_values[] = {1, 2, 3, 4, 11, 12, 13, 14, 5, 6, 15, 16};
    struct tensor* C_right = new_tensor(shape_C, 3, C_right_values);

    printf("----- C right -----\n");
    print_tensor(C_right);
    printf("----- C -----\n");
    print_tensor_verbose(C, 1);

    int failure = !tensors_equal(C_right, C);

    tensor_free(A);
    tensor_free(B);
    tensor_free(C);

    if (failure > 0) {
        printf("\033[1;31mFail\033[0m\n");
    } else {
        printf("\033[1;32mSuccess\033[0m\n");
    }

    return failure;
}

int main()
{
    int failures_count = 0;

    failures_count += test_basic();
    failures_count += test_tensor_transpose();
    failures_count += test_matrix_mult();
    failures_count += test_tensor_mult();
    failures_count += test_tensor_mult2();
    failures_count += test_tensor_mult3();
    failures_count += test_tensor_inner_outer();
    failures_count += test_append();
    failures_count += test_append_harder();

    if (failures_count > 0) {
        printf("\033[1;31mFailed %d test(s)!\033[0m\n", failures_count);
    } else {
        printf("\033[1;32mAll tests passed! :)\033[0m\n");
    }
    return 0;
}
